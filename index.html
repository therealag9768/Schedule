<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Schedule App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#F7F7F7}
header{padding:14px;background:#1e88e5;color:#fff;font-size:24px;font-weight:600;text-align:center}
#app{padding:12px;display:flex;flex-direction:column;align-items:center}
#monthNav{display:flex;justify-content:space-between;align-items:center;width:90%;max-width:400px;margin-bottom:6px}
#monthNav button{padding:6px 12px;font-size:16px;border:none;border-radius:6px;background:#1e88e5;color:#fff;cursor:pointer}
#monthNav span{font-size:20px;font-weight:600}
#calendarHeaderWrapper{width:100%;max-width:1075px;margin-bottom:6px;overflow:hidden}
#weekdayHeader{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;width:100%;padding:0 3px;box-sizing:border-box;font-size:clamp(14px,2.2vw,18px);font-weight:600;color:#555;text-align:center;background:#f0f0f0;border-radius:8px;padding:8px 0}
#weekdayHeader div{text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#calendarContainer{width:100%;max-width:1075px;overflow-x:auto;margin-bottom:12px;min-height:400px;scroll-behavior:smooth}
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;width:100%;padding:0;box-sizing:border-box;grid-auto-rows:1fr;min-height:60vh;height:auto}
.calendar-day{background:#fff;border-radius:14px;padding:8px;display:flex;flex-direction:column;height:100%;min-height:120px;box-sizing:border-box;overflow:hidden;position:relative}
.calendar-date{font-size:clamp(16px,3vw,20px);font-weight:600;color:#444;margin-bottom:6px}
.calendar-job{padding:4px 6px;border-radius:10px;font-size:clamp(14px,2.5vw,18px);color:#fff;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;max-height:32px;line-height:32px}
.calendar-more{font-size:clamp(12px,2vw,14px);color:#666;margin-top:auto;text-align:center}
#jobTableContainer{width:100%;max-width:1075px;overflow-x:auto;margin-bottom:12px}
#jobTable{width:100%;border-collapse:collapse}
#jobTable th,#jobTable td{padding:8px;border:1px solid #ccc;text-align:left;font-size:22px}
#jobTable th{cursor:pointer;background:#eee}
.status-blue{background:#2196f3;color:#fff}
.status-green{background:#00d27f;color:#fff}
.status-yellow{background:#fbc02d;color:#000}
.status-red{background:#ff5252;color:#fff}
.status-standby{background:#d3d3d3;color:#000}
.pending-report{background:#fff3cd;color:#856404;border-left:5px solid #ffc107}
#detailPane{position:fixed;top:0;right:-100%;width:100%;height:100%;background:#fff;z-index:50;transition:.25s ease;overflow-y:auto;touch-action:pan-y;display:flex;flex-direction:column}
@media(min-width:900px){#detailPane{width:50%;right:-50%}}
#detailPane.open{right:0}
#detailHeader{padding:16px;background:#1e88e5;color:#fff;font-size:18px;font-weight:600;display:flex;align-items:center;position:relative}
#backBtn{font-size:22px;margin-right:12px;cursor:pointer}
#detailTitle{flex:1}
#editBtn{position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:24px;cursor:pointer;color:#fff}
.section{padding:16px;border-bottom:1px solid #eee}
.row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:16px}
select,textarea,input[type="text"],input[type="date"]{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;font-size:16px;box-sizing:border-box;margin-top:6px}
textarea#notes{resize:none;overflow:hidden;min-height:100px}
.detail-pane-button{padding:14px;min-height:52px;border:none;border-radius:14px;background:#1e88e5;color:#fff;font-size:16px;cursor:pointer;text-align:center;box-sizing:border-box;font-weight:500;width:100%;max-width:none}
.btnGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
.btnGrid button{@extend .detail-pane-button}
.contactSection{text-align:center}
.contactButtons{display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap}
.contactButtons button{@extend .detail-pane-button}
.delete-job-btn{background:#d32f2f !important;color:#fff;margin-top:16px;font-weight:bold;}
.pending-section{margin-bottom:20px;border:1px solid #ffc107;background:#fff3cd;padding:10px;border-radius:8px}
.pending-section h3{margin:0 0 10px 0;color:#856404}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#4caf50;color:white;padding:12px 24px;border-radius:8px;z-index:1000;opacity:0;transition:opacity 0.5s}
#toast.show{opacity:1}
@media(max-width:768px){.btnGrid{grid-template-columns:1fr;gap:10px}.contactButtons{flex-direction:column;gap:10px}}
#jobSearch{margin:12px 0;padding:8px 12px;font-size:18px;border-radius:8px;border:1px solid #ccc;width:100%;max-width:1075px;box-sizing:border-box}
#spreadsheetView{display:none;flex-direction:column;align-items:center;width:100%;padding:12px;box-sizing:border-box}
#spreadsheetView.active{display:flex}
#spreadsheetContainer{width:100%;max-width:1075px;height:70vh;border:1px solid #ccc;border-radius:8px;overflow:hidden;background:#fff}
#spreadsheetControls{display:flex;gap:12px;margin:12px 0;flex-wrap:wrap;justify-content:center;align-items:center}
#spreadsheetControls button{padding:10px 16px;border:none;border-radius:8px;background:#1e88e5;color:#fff;font-size:16px;cursor:pointer}
#spreadsheetSearch{margin-bottom:12px;padding:8px 12px;font-size:18px;border-radius:8px;border:1px solid #ccc;width:100%;max-width:1075px;box-sizing:border-box}
#editPane{position:fixed;top:0;right:-100%;width:100%;height:100%;background:#fff;z-index:60;transition:.25s ease;overflow-y:auto;display:flex;flex-direction:column}
@media(min-width:900px){#editPane{width:50%;right:-50%}}
#editPane.open{right:0}
#editHeader{padding:16px;background:#1e88e5;color:#fff;font-size:18px;font-weight:600;display:flex;align-items:center}
#editBackBtn{font-size:22px;margin-right:12px;cursor:pointer}
#editTitle{flex:1}
#saveEditBtn{padding:14px;border:none;border-radius:14px;background:#4caf50;color:#fff;font-size:16px;cursor:pointer;margin:20px auto;display:block;width:90%;max-width:400px}
.sheet-link{color:#1e88e5;text-decoration:underline;font-weight:600;margin:12px 0;display:block;text-align:center;}
html,body{width:100%;height:100%;margin:0;padding:0;overflow-x:hidden}
</style>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<header>Schedule App</header>
<div id="app">
  <div id="monthNav"><button id="prevMonth">‚Äπ</button><span id="currentMonthLabel"></span><button id="nextMonth">‚Ä∫</button></div>
  <div id="calendarHeaderWrapper">
    <div id="weekdayHeader"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
  </div>
  <div id="calendarContainer"><div id="calendar"></div></div>
  <input type="text" id="jobSearch" placeholder="Search jobs by name, number, or customer...">
  <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;justify-content:center">
    <button id="uploadCSV">Upload CSV / XLS</button>
    <button id="downloadAirOne">Download Air One XLS</button>
    <button id="loadSheet">Load from Google Sheet</button>
    <button id="saveSheet">Save to Google Sheet</button>
    <button id="viewSpreadsheet">View All Jobs Spreadsheet</button>
  </div>
  <div id="jobTableContainer">
    <div id="pendingReportsSection" class="pending-section" style="display:none;">
      <h3>Pending Report Sent Confirmation</h3>
      <table id="pendingTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Job Number</th>
            <th>Field Ops</th>
            <th>Start Date</th>
            <th>Field Hours</th>
            <th>Customer</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <table id="jobTable">
      <thead>
        <tr>
          <th data-field="name">Name</th>
          <th data-field="number">Job Number</th>
          <th data-field="fieldOps">Field Ops</th>
          <th data-field="startDate">Start Date</th>
          <th data-field="hours">Field Hours</th>
          <th data-field="customer">Customer</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div id="spreadsheetView">
  <input type="text" id="spreadsheetSearch" placeholder="Search all jobs in spreadsheet (any field)...">
  <div id="spreadsheetControls">
    <button id="backToMain">‚Üê Back to Calendar</button>
    <button id="addRow">Add New Row</button>
    <button id="addColumn">Add New Column</button>
  </div>
  <a href="https://docs.google.com/spreadsheets/d/1HHigA2FLOc-R4s4nBKKmQb8cJo4hLdrVn5ACUA-HNjY" target="_blank" class="sheet-link">
    ‚Üí Open this data directly in Google Sheets ‚Üê
  </a>
  <div id="spreadsheetContainer"></div>
</div>
<div id="detailPane">
  <div id="detailHeader">
    <span id="backBtn">‚Üê</span>
    <span id="detailTitle"></span>
    <span id="editBtn">‚úé</span>
  </div>
  <div class="section" id="detailInfo"></div>
  <div class="section">
    <label>Report sent?</label>
    <input type="checkbox" id="reportSentToggle">
  </div>
  <div class="section contactSection">
    <div style="margin-bottom:8px;font-weight:600">Contact Client PM:</div>
    <div class="contactButtons">
      <button id="callPM">Call</button>
      <button id="emailPM">Email</button>
      <button id="textPM">Text</button>
    </div>
  </div>
  <div class="section">
    <div class="btnGrid">
      <button id="copyJob">Job Number</button>
      <button id="openAir">Open Air One</button>
      <button id="reportReady">Report Ready</button>
      <button id="observationsBtn">Observations</button>
      <button id="jobLocation">Job Location</button>
      <button id="startEmail">Start Date Email</button>
      <button id="airOneSchedule">Air One Schedule</button>
    </div>
  </div>
  <div class="section">
    <div id="emailStamps"></div>
    <label>Notes:</label>
    <textarea id="notes" placeholder="Notes"></textarea>
  </div>
  <div class="section">
    <button id="deleteJobBtn" class="detail-pane-button delete-job-btn">Delete This Job</button>
  </div>
</div>
<div id="editPane">
  <div id="editHeader">
    <span id="editBackBtn">‚Üê</span>
    <span id="editTitle">Edit Job</span>
  </div>

  <!-- White background - main fields -->
  <div class="section" style="background:white; border-radius:12px; margin:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
    <label>Field Ops</label>
    <select id="editFieldOps">
      <option value="Complete">Complete</option>
      <option value="Field Ready">Field Ready</option>
      <option value="Standby">Standby</option>
      <option value="Stalled">Stalled</option>
      <option value="TAB">TAB</option>
    </select>

    <label>Name</label>
    <input type="text" id="editName" placeholder="Job Name">

    <label>Job Number</label>
    <input type="text" id="editNumber" placeholder="Job Number">

    <label>Location</label>
    <input type="text" id="editLocation" placeholder="Location">

    <label>Field Hours</label>
    <input type="text" id="editHours" placeholder="Field Hours">

    <label>Start Date</label>
    <input type="date" id="editStartDate">

    <label>Scheduled Date</label>
    <input type="date" id="editScheduledDate">

    <label>Pre Con Email</label>
    <select id="editPreConEmail"></select>

    <label>TBE Email</label>
    <select id="editTbeEmail"></select>
  </div>

  <!-- Dark background - manual entry overrides -->
  <div class="section" style="background:#2c2c2c; color:#eee; border-radius:12px; margin:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.3);">
    <div style="margin-bottom:12px; font-weight:600;">Manual Entry (override)</div>

    <label>Customer</label>
    <input type="text" id="newCustomer" placeholder="Customer name">

    <label>Client Project Manager</label>
    <input type="text" id="newClientProjectManager" placeholder="PM Name">

    <label>PM Number</label>
    <input type="text" id="newPmNumber" placeholder="Phone number">

    <label>PM Email</label>
    <input type="text" id="newPmEmail" placeholder="Email address">
  </div>

  <!-- Light blue background - select from existing -->
  <div class="section" style="background:#e3f2fd; border-radius:12px; margin:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
    <div style="margin-bottom:12px; font-weight:600;">Select from Existing</div>

    <label>Customer</label>
    <select id="editCustomer"></select>

    <label>Client Project Manager</label>
    <select id="editClientProjectManager"></select>

    <label>PM Number</label>
    <input type="text" id="editPmNumber" readonly placeholder="Select name above">

    <label>PM Email</label>
    <input type="text" id="editPmEmail" readonly placeholder="Select name above">
  </div>

  <button id="saveEditBtn">Save Changes</button>
</div>
<div id="toast">Job number copied!</div>
<div id="downloadModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:100">
  <div style="background:#fff;padding:24px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:12px">
    <div>Air One XLS downloaded.</div>
    <button id="triggerUpload">Upload File</button>
  </div>
</div>

<script>
// === GOOGLE SHEETS CONFIG ===
const SHEET_ID = '1HHigA2FLOc-R4s4nBKKmQb8cJo4hLdrVn5ACUA-HNjY';
const API_KEY = 'AIzaSyAOMHM9t9e1VSLWJRMF683lwgu_4vmr65g';
const CLIENT_ID = '1002184185824-06elg3bgd32qso2ckp7tpfbgeojri6r2.apps.googleusercontent.com';
const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
let tokenClient;
let gapiInited = false;
let gisInited = false;
let authInProgress = false;
let contacts = [];

function gapiLoad() {
  gapi.load('client', async () => {
    try {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      checkAndAutoLoad();
    } catch (err) {
      console.error('GAPI error:', err);
    }
  });
}

function gisLoaded() {
  try {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: '',
    });
    gisInited = true;
    checkAndAutoLoad();
  } catch (err) {
    console.error('GIS error:', err);
  }
}

function checkAndAutoLoad() {
  if (gapiInited && gisInited && !authInProgress) {
    loadSheetData(true);
    loadContacts(true);
  }
}

async function loadSheetData(silent = false) {
  if (!gapiInited) {
    if (!silent) alert('Google API not ready.');
    return;
  }
  try {
    const response = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: 'Sheet1!A1:Z1000',
    });
    const rows = response.result.values || [];
    if (rows.length === 0) {
      if (!silent) alert('No data found.');
      return;
    }
    const headers = rows[0].map(h => h ? h.trim() : '');
    const seenNumbers = new Set();
    jobs.length = 0;
    for (let i = 1; i < rows.length; i++) {
      const r = {};
      headers.forEach((h, idx) => {
        r[h] = rows[i][idx] !== undefined ? String(rows[i][idx]).trim() : '';
      });
      const jobNumber = r['Job Number'] || '';
      if (jobNumber && seenNumbers.has(jobNumber)) continue;
      seenNumbers.add(jobNumber);
      let rawStart = r['Start Date'] || '';
      let rawSched = r['Scheduled Date'] || rawStart;
      let partsStart = rawStart.split('/');
      if (partsStart.length === 3) {
        partsStart[0] = parseInt(partsStart[0], 10).toString();
        partsStart[1] = parseInt(partsStart[1], 10).toString();
        rawStart = partsStart.join('/');
      }
      let partsSched = rawSched.split('/');
      if (partsSched.length === 3) {
        partsSched[0] = parseInt(partsSched[0], 10).toString();
        partsSched[1] = parseInt(partsSched[1], 10).toString();
        rawSched = partsSched.join('/');
      }
      jobs.push({
        name: r['Name'] || '',
        number: jobNumber,
        startDate: rawStart,
        scheduledDate: rawSched,
        status: r['Field Ops'] || 'TAB',
        fieldOps: r['Field Ops'] || 'TAB',
        location: r['Location'] || '',
        customer: r['Customer'] || '',
        hours: r['Field Hours'] || '',
        clientProjectManager: r['Client Project Manager'] || '',
        pmNumber: r['PM Number'] || '',
        pmEmail: r['PM Email'] || '',
        preConEmail: r['Pre Con Email'] || '',
        tbeEmail: r['TBE Email'] || '',
        notes: r['Notes'] || '',
        reportSent: r['Report Sent'] === 'TRUE',
        reportReadySentAt: r['Report Ready Sent At'] || '',
        startEmailSentAt: r['Start Email Sent At'] || '',
        observationsSentAt: r['Observations Sent At'] || '',
        statusWarning: false,
        newJobFlag: false
      });
    }
    renderAll();
    if (!silent) alert(`Loaded ${jobs.length} jobs!`);
  } catch (err) {
    console.error('Load error:', err);
    if (!silent) alert('Load failed.');
  }
}

async function loadContacts(silent = false) {
  if (!gapiInited) {
    if (!silent) alert('Google API not ready for Contacts.');
    return;
  }
  try {
    const response = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: 'Contacts!A1:Z1000',
    });
    const rows = response.result.values || [];
    if (rows.length <= 1) return;
    const headers = rows[0].map(h => h.trim());
    contacts = rows.slice(1).map(row => {
      const c = {};
      headers.forEach((h, idx) => {
        c[h] = row[idx] !== undefined ? String(row[idx]).trim() : '';
      });
      return c;
    });
    console.log(`Loaded ${contacts.length} contacts`);
  } catch (err) {
    console.error('Contacts load error:', err);
  }
}

async function saveToSheet(silent = false) {
  if (authInProgress) return;
  authInProgress = true;
  if (!gapi.client.getToken()) {
    tokenClient.callback = async (resp) => {
      authInProgress = false;
      if (resp.error) {
        if (!silent) alert('Sign-in failed.');
        return;
      }
      await performSave(silent);
    };
    tokenClient.requestAccessToken({prompt: 'consent'});
  } else {
    await performSave(silent);
    authInProgress = false;
  }
}
async function performSave(silent = false) {
  try {
    const headers = ['Name','Job Number','Field Ops','Field Hours','Start Date','Scheduled Date','Customer','Client Project Manager','PM Number','PM Email','Location','Pre Con Email','TBE Email','Notes','Report Sent','Report Ready Sent At','Start Email Sent At','Observations Sent At'];
    const values = [headers];
    jobs.forEach(j => {
      values.push([
        j.name || '',
        j.number || '',
        j.fieldOps || 'TAB',
        j.hours || '',
        j.startDate || '',
        j.scheduledDate || j.startDate || '',
        j.customer || '',
        j.clientProjectManager || '',
        j.pmNumber || '',
        j.pmEmail || '',
        j.location || '',
        j.preConEmail || '',
        j.tbeEmail || '',
        j.notes || '',
        j.reportSent ? 'TRUE' : 'FALSE',
        j.reportReadySentAt || '',
        j.startEmailSentAt || '',
        j.observationsSentAt || ''
      ]);
    });
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SHEET_ID,
      range: 'Sheet1!A1',
      valueInputOption: 'RAW',
      resource: { values }
    });
    if (!silent) alert('Saved!');
  } catch (err) {
    console.error('Save error:', err);
    if (!silent) alert('Save failed.');
  }
}
let autoSaveTimeout;
function triggerAutoSave() {
  clearTimeout(autoSaveTimeout);
  autoSaveTimeout = setTimeout(() => saveToSheet(true), 2000);
}
document.getElementById('loadSheet').onclick = () => loadSheetData(false);
document.getElementById('saveSheet').onclick = () => saveToSheet(false);
gapiLoad();
gisLoaded();

// === BASELINE CODE ===
const jobs = [];
let activeJob = null;
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const sortDirection = {};
let previousJobList = [];
function statusClass(v) {
  v = (v || 'TAB').toLowerCase();
  if (v === 'complete') return 'status-blue';
  if (v === 'field ready') return 'status-green';
  if (v === 'tab') return 'status-yellow';
  if (v === 'stalled') return 'status-red';
  if (v === 'standby') return 'status-standby';
  return 'status-yellow';
}
function daysInMonth(month, year) {
  return new Date(year, month + 1, 0).getDate();
}
function autoGrowNotes() {
  const notes = document.getElementById('notes');
  if (notes) {
    notes.style.height = 'auto';
    notes.style.height = notes.scrollHeight + 'px';
  }
}
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}
function renderCalendar() {
  document.getElementById('currentMonthLabel').textContent = monthNames[currentMonth] + ' ' + currentYear;
  const cal = document.getElementById('calendar');
  cal.innerHTML = '';
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const days = daysInMonth(currentMonth, currentYear);
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day';
    cal.appendChild(empty);
  }
  for (let i = 1; i <= days; i++) {
    const day = document.createElement('div');
    day.className = 'calendar-day';
    const dateStr = `${currentMonth + 1}/${i}/${currentYear}`;
    day.dataset.date = dateStr;
    day.innerHTML = `<div class="calendar-date">${i}</div>`;
    const dayJobs = jobs.filter(j => j.scheduledDate === dateStr);
    dayJobs.slice(0,4).forEach(j => {
      const el = document.createElement('div');
      el.className = 'calendar-job ' + statusClass(j.status || j.fieldOps);
      el.textContent = j.name || 'Unnamed';
      el.onclick = () => openJob(j);
      day.appendChild(el);
    });
    if (dayJobs.length > 4) {
      const more = document.createElement('div');
      more.className = 'calendar-more';
      more.textContent = `+${dayJobs.length - 4} more`;
      day.appendChild(more);
    }
    cal.appendChild(day);
  }
}
let draggedJob = null;
function makeJobsDraggable() {
  document.querySelectorAll('.calendar-job').forEach(el => {
    el.draggable = true;
    el.ondragstart = e => {
      draggedJob = jobs.find(j => j.name === el.textContent && j.scheduledDate === el.parentElement.dataset.date);
      e.dataTransfer.effectAllowed = 'move';
    };
  });
  document.querySelectorAll('.calendar-day').forEach(day => {
    day.ondragover = e => e.preventDefault();
    day.ondrop = e => {
      e.preventDefault();
      if (draggedJob) {
        draggedJob.scheduledDate = day.dataset.date;
        renderAll();
        triggerAutoSave();
        draggedJob = null;
      }
    };
  });
}
document.addEventListener('click', e => {
  if (e.target.classList.contains('calendar-day') && e.target.children.length === 1) {
    const selectedDate = e.target.dataset.date;
    const jobName = prompt('Enter Job Name:');
    if (!jobName) return;
    const jobNumber = prompt('Enter Job Number:') || '';
    if (!jobNumber) return;
    if (jobs.some(j => j.number === jobNumber)) {
      alert(`Job with number ${jobNumber} already exists!`);
      return;
    }
    const customer = prompt('Enter Customer:') || '';
    jobs.push({
      name: jobName,
      number: jobNumber,
      startDate: selectedDate,
      scheduledDate: selectedDate,
      status: 'TAB',
      fieldOps: 'TAB',
      location: '',
      customer: customer,
      clientProjectManager: '',
      pmNumber: '',
      pmEmail: '',
      preConEmail: '',
      tbeEmail: '',
      notes: '',
      reportSent: false,
      reportReadySentAt: '',
      startEmailSentAt: '',
      observationsSentAt: '',
      statusWarning: false,
      newJobFlag: false
    });
    renderAll();
    triggerAutoSave();
  }
});
function renderList(filteredJobs) {
  const tbody = document.querySelector('#jobTable tbody');
  tbody.innerHTML = '';
  const listToRender = filteredJobs || jobs;
  listToRender.forEach(j => {
    const warningIcon = j.statusWarning ? '‚ö†Ô∏è ' : (j.newJobFlag ? 'üî¥ ' : '');
    const tr = document.createElement('tr');
    tr.className = statusClass(j.status || j.fieldOps);
    tr.innerHTML = `<td>${warningIcon}${j.name||''}</td><td>${j.number||''}</td><td>${j.fieldOps||''}</td><td>${j.startDate||''}</td><td>${j.hours||''}</td><td>${j.customer||''}</td>`;
    tr.onclick = () => openJob(j);
    tbody.appendChild(tr);
  });
}
function renderPendingReports() {
  const pendingSection = document.getElementById('pendingReportsSection');
  const pendingTbody = document.querySelector('#pendingTable tbody');
  pendingTbody.innerHTML = '';
  const pendingJobs = jobs.filter(j => j.status === 'Complete' && !j.reportSent);
  if (pendingJobs.length === 0) {
    pendingSection.style.display = 'none';
    return;
  }
  pendingSection.style.display = 'block';
  pendingJobs.forEach(j => {
    const tr = document.createElement('tr');
    tr.className = 'pending-report';
    tr.innerHTML = `<td>${j.name||''} ‚ö†Ô∏èREPORT SENT?</td><td>${j.number||''}</td><td>${j.fieldOps||''}</td><td>${j.startDate||''}</td><td>${j.hours||''}</td><td>${j.customer||''}</td>`;
    tr.onclick = () => openJob(j);
    pendingTbody.appendChild(tr);
  });
}
function openJob(j) {
  activeJob = j;
  document.getElementById('detailTitle').textContent = `${j.name||'Unnamed'} ${j.number||''}`;
  const info = document.getElementById('detailInfo');
  info.innerHTML = `<div class="row"><span>Location</span><span>${j.location||''}</span></div>
                   <div class="row"><span>Field Hours</span><span>${j.hours||''}</span></div>
                   <div class="row"><span>Official Start Date</span><span>${j.startDate||''}</span></div>
                   <div class="row"><span>Scheduled Date</span><span>${j.scheduledDate||j.startDate||''}</span></div>
                   <div class="row"><span>Customer</span><span>${j.customer||''}</span></div>
                   <div class="row"><span>Client Project Manager</span><span>${j.clientProjectManager||'N/A'}</span></div>
                   <div class="row"><span>PM Number</span><span>${j.pmNumber||'N/A'}</span></div>
                   <div class="row"><span>PM Email</span><span>${j.pmEmail||'N/A'}</span></div>`;
  const notes = document.getElementById('notes');
  notes.value = j.notes || '';
  autoGrowNotes();
  const stamps = document.getElementById('emailStamps');
  stamps.innerHTML = '';
  if (j.reportReadySentAt) {
    stamps.innerHTML += `<div>‚úÖ Report ready email sent ${j.reportReadySentAt}</div>`;
  }
  if (j.startEmailSentAt) {
    stamps.innerHTML += `<div>üî¥ PM Start date email sent ${j.startEmailSentAt}</div>`;
  }
  if (j.observationsSentAt) {
    stamps.innerHTML += `<div>üü° Observations email sent ${j.observationsSentAt}</div>`;
  }
  const toggle = document.getElementById('reportSentToggle');
  toggle.checked = j.reportSent || false;
  detailPane.classList.add('open');
  renderPendingReports();
}
document.getElementById('notes').addEventListener('input', () => {
  if (activeJob) {
    activeJob.notes = document.getElementById('notes').value;
    autoGrowNotes();
    triggerAutoSave();
  }
});
document.getElementById('reportSentToggle').addEventListener('change', (e) => {
  if (activeJob) {
    activeJob.reportSent = e.target.checked;
    triggerAutoSave();
    renderPendingReports();
  }
});
function getUnique(field) {
  return [...new Set(jobs.map(j => j[field] || '').filter(v => v.trim()))].sort();
}
function populateSelect(id, field) {
  const select = document.getElementById(id);
  select.innerHTML = '<option value="">-- Select --</option>';
  getUnique(field).forEach(val => {
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  });
}
function openEditPane() {
  if (!activeJob) return;
  document.getElementById('editTitle').textContent = `Edit: ${activeJob.name || 'Job'}`;

  document.getElementById('editFieldOps').value = activeJob.fieldOps || 'TAB';
  document.getElementById('editName').value = activeJob.name || '';
  document.getElementById('editNumber').value = activeJob.number || '';
  document.getElementById('editLocation').value = activeJob.location || '';
  document.getElementById('editHours').value = activeJob.hours || '';

  let startIso = '';
  if (activeJob.startDate) {
    const parts = activeJob.startDate.split('/');
    if (parts.length === 3) {
      startIso = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
    }
  }
  document.getElementById('editStartDate').value = startIso;

  let schedIso = '';
  if (activeJob.scheduledDate) {
    const parts = activeJob.scheduledDate.split('/');
    if (parts.length === 3) {
      schedIso = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
    }
  } else if (startIso) {
    schedIso = startIso;
  }
  document.getElementById('editScheduledDate').value = schedIso;

  populateSelect('editPreConEmail', 'preConEmail');
  populateSelect('editTbeEmail', 'tbeEmail');
  document.getElementById('editPreConEmail').value = activeJob.preConEmail || '';
  document.getElementById('editTbeEmail').value = activeJob.tbeEmail || '';

  populateSelect('editCustomer', 'customer');
  document.getElementById('editCustomer').value = activeJob.customer || '';

  const pmSelect = document.getElementById('editClientProjectManager');
  pmSelect.innerHTML = '<option value="">-- Select PM --</option>';
  const pmNames = [...new Set(contacts.map(c => c['Client Project Manager'] || '').filter(Boolean))].sort();
  pmNames.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    pmSelect.appendChild(opt);
  });
  pmSelect.value = activeJob.clientProjectManager || '';

  if (activeJob.clientProjectManager) {
    const contact = contacts.find(c => c['Client Project Manager'] === activeJob.clientProjectManager);
    if (contact) {
      document.getElementById('editPmNumber').value = contact['PM Number'] || '';
      document.getElementById('editPmEmail').value = contact['PM Email'] || '';
    }
  }

  document.getElementById('newCustomer').value = '';
  document.getElementById('newClientProjectManager').value = '';
  document.getElementById('newPmNumber').value = '';
  document.getElementById('newPmEmail').value = '';

  editPane.classList.add('open');
}

document.addEventListener('DOMContentLoaded', () => {
  const pmSelect = document.getElementById('editClientProjectManager');
  if (pmSelect) {
    pmSelect.addEventListener('change', (e) => {
      const selectedName = e.target.value.trim();
      if (!selectedName) {
        document.getElementById('editPmNumber').value = '';
        document.getElementById('editPmEmail').value = '';
        return;
      }
      const contact = contacts.find(c => c['Client Project Manager'] === selectedName);
      if (contact) {
        document.getElementById('editPmNumber').value = contact['PM Number'] || '';
        document.getElementById('editPmEmail').value = contact['PM Email'] || '';
      } else {
        document.getElementById('editPmNumber').value = '';
        document.getElementById('editPmEmail').value = '';
      }
    });
  }
});

function saveEditPane() {
  if (!activeJob) return;

  activeJob.fieldOps = document.getElementById('editFieldOps').value || activeJob.fieldOps;
  activeJob.status = activeJob.fieldOps;
  activeJob.name = document.getElementById('editName').value.trim() || activeJob.name;
  activeJob.number = document.getElementById('editNumber').value.trim() || activeJob.number;
  activeJob.location = document.getElementById('editLocation').value.trim() || activeJob.location;
  activeJob.hours = document.getElementById('editHours').value.trim() || activeJob.hours;

  let startDateVal = document.getElementById('editStartDate').value;
  if (startDateVal) {
    const parts = startDateVal.split('-');
    activeJob.startDate = `${parseInt(parts[1],10)}/${parseInt(parts[2],10)}/${parts[0]}`;
  }

  let schedDateVal = document.getElementById('editScheduledDate').value;
  if (schedDateVal) {
    const parts = schedDateVal.split('-');
    activeJob.scheduledDate = `${parseInt(parts[1],10)}/${parseInt(parts[2],10)}/${parts[0]}`;
  } else {
    activeJob.scheduledDate = activeJob.startDate;
  }

  activeJob.preConEmail = document.getElementById('editPreConEmail').value || activeJob.preConEmail;
  activeJob.tbeEmail = document.getElementById('editTbeEmail').value || activeJob.tbeEmail;

  const customer = document.getElementById('editCustomer').value.trim();
  if (customer) activeJob.customer = customer;

  const pmName = document.getElementById('editClientProjectManager').value.trim();
  if (pmName) activeJob.clientProjectManager = pmName;

  activeJob.pmNumber = document.getElementById('editPmNumber').value.trim() || activeJob.pmNumber;
  activeJob.pmEmail = document.getElementById('editPmEmail').value.trim() || activeJob.pmEmail;

  const manualCustomer = document.getElementById('newCustomer').value.trim();
  if (manualCustomer) activeJob.customer = manualCustomer;

  const manualPM = document.getElementById('newClientProjectManager').value.trim();
  if (manualPM) activeJob.clientProjectManager = manualPM;

  const manualPhone = document.getElementById('newPmNumber').value.trim();
  if (manualPhone) activeJob.pmNumber = manualPhone;

  const manualEmail = document.getElementById('newPmEmail').value.trim();
  if (manualEmail) activeJob.pmEmail = manualEmail;

  editPane.classList.remove('open');
  renderAll();
  triggerAutoSave();
  openJob(activeJob);
}
function triggerFileInput() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv,.xls,.xlsx';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = ev.target.result;
        const workbook = XLSX.read(data, { type: file.name.endsWith('.csv') ? 'string' : 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        if (jsonData.length < 1) {
          alert('Empty file.');
          return;
        }
        const headers = jsonData[0].map(h => (h || '').trim());
        const rows = jsonData.slice(1);
        rows.forEach(row => {
          const r = {};
          headers.forEach((h, i) => {
            r[h] = row[i] !== undefined ? String(row[i]).trim() : '';
          });
          if (!r['Name'] && !r['Job Number']) return;
          const jobNumber = r['Job Number'] || '';
          if (jobNumber && jobs.some(j => j.number === jobNumber)) {
            const existing = jobs.find(j => j.number === jobNumber);
            if ((existing.status || '') !== r['Field Ops']) {
              existing.statusWarning = true;
            }
            return;
          }
          let rawStart = r['Start Date'] || '';
          let partsStart = rawStart.split('/');
          if (partsStart.length === 3) {
            partsStart[0] = parseInt(partsStart[0], 10).toString();
            partsStart[1] = parseInt(partsStart[1], 10).toString();
            rawStart = partsStart.join('/');
          }
          const newJob = {
            name: r['Name'] || '',
            number: jobNumber,
            startDate: rawStart,
            scheduledDate: rawStart,
            status: r['Field Ops'] || 'TAB',
            fieldOps: r['Field Ops'] || 'TAB',
            location: r['Location'] || '',
            customer: r['Customer'] || '',
            hours: r['Field Hours'] || '',
            clientProjectManager: r['Client Project Manager'] || '',
            pmNumber: r['PM Number'] || '',
            pmEmail: r['PM Email'] || '',
            preConEmail: r['Pre Con Email'] || '',
            tbeEmail: r['TBE Email'] || '',
            notes: '',
            reportSent: false,
            reportReadySentAt: '',
            startEmailSentAt: '',
            observationsSentAt: '',
            statusWarning: false,
            newJobFlag: previousJobList.length > 0 ? true : false
          };
          jobs.push(newJob);
        });
        previousJobList = jobs.map(j => ({name: j.name, number: j.number}));
        sortJobs('fieldOps');
        renderAll();
        triggerAutoSave();
        alert('Imported successfully!');
      } catch (err) {
        console.error('Import error:', err);
        alert('Import failed: ' + (err.message || 'Unknown error'));
      }
    };
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsArrayBuffer(file);
    }
  };
  input.click();
}
document.getElementById('uploadCSV').onclick = triggerFileInput;
document.getElementById('downloadAirOne').onclick = () => {
  window.open('https://airone.palmettoairbalance.com/project_management/projects/?_export=xls','_blank');
  document.getElementById('downloadModal').style.display = 'flex';
};
document.getElementById('triggerUpload').onclick = () => {
  triggerFileInput();
  document.getElementById('downloadModal').style.display = 'none';
};
let touchStartX = 0;
detailPane.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
detailPane.addEventListener('touchmove', e => { if (e.touches[0].clientX - touchStartX > 100) detailPane.classList.remove('open'); });
editPane.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
editPane.addEventListener('touchmove', e => { if (e.touches[0].clientX - touchStartX > 100) editPane.classList.remove('open'); });
document.getElementById('callPM').onclick = () => {
  if (activeJob && activeJob.pmNumber) {
    window.open(`tel:${activeJob.pmNumber.replace(/[^\d+]/g, '')}`,'_blank');
  } else {
    alert('No PM phone number available.');
  }
};
document.getElementById('emailPM').onclick = () => {
  if (!activeJob) return;
  const pmEmail = activeJob.pmEmail || '';
  if (!pmEmail) {
    alert('No PM email available.');
    return;
  }
  const subject = `üü° ${activeJob.name || ''} ${activeJob.number || ''}`;
  let firstName = 'All';
  if (activeJob.clientProjectManager) {
    const nameParts = activeJob.clientProjectManager.trim().split(' ');
    firstName = nameParts[0] || 'All';
  }
  const body = `${firstName},

[Your message here]

Thank you,
`;
  window.open(`mailto:${encodeURIComponent(pmEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
};
document.getElementById('textPM').onclick = () => {
  if (!activeJob) return;
  const pmNumber = activeJob.pmNumber || '';
  if (!pmNumber) {
    alert('No PM phone number available.');
    return;
  }
  const body = `${activeJob.name || ''} ${activeJob.number || ''}`;
  window.open(`sms:${pmNumber.replace(/[^\d+]/g, '')}?body=${encodeURIComponent(body)}`, '_blank');
};
document.getElementById('copyJob').onclick = () => {
  if (activeJob && activeJob.number) {
    navigator.clipboard.writeText(activeJob.number).then(() => {
      showToast('Job number copied!');
    }).catch(() => {
      showToast('Copy failed');
    });
  }
};
document.getElementById('openAir').onclick = () => window.open('https://airone.palmettoairbalance.com/project_management/projects/','_blank');
document.getElementById('airOneSchedule').onclick = () => window.open('https://airone.palmettoairbalance.com/scheduling/tech/','_blank');
document.getElementById('jobLocation').onclick = () => {
  if (activeJob) {
    const loc = activeJob.location || '';
    if (loc) navigator.clipboard.writeText(loc).catch(() => {});
    const mapsUrl = loc ? `https://www.google.com/maps/dir///${encodeURIComponent(loc)}/@35.5736863,-78.5547264,14z/data=!4m2!4m1!3e0?entry=ttu` : 'https://www.google.com/maps/dir///@35.5736863,-78.5547264,14z/data=!4m2!4m1!3e0?entry=ttu';
    window.open(mapsUrl,'_blank');
  }
};
document.getElementById('reportReady').onclick = () => {
  if (!activeJob) return;
  const preConEmail = activeJob.preConEmail || '';
  const tbeEmail = activeJob.tbeEmail || '';
  const recipients = [preConEmail, tbeEmail].filter(e => e).join(',');
  const ccList = 'dfunchess@palmettoairbalance.com';
  const subject = `‚úÖ ${activeJob.name || ''} ${activeJob.number || ''}`;
  const body = `All,

1.) Job is complete.
2.) Synopsis added.
3.) No changes to drawings.
4.) Report data is ready for TBE review.
5.) Job has or does not have an engineer stamp. Guarantee ?

Thank you,
`;
  const mailtoLink = `mailto:${recipients ? encodeURIComponent(recipients) : ''}?cc=${encodeURIComponent(ccList)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(mailtoLink, '_blank');
  const now = new Date();
  const stamp = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')} ${now.getHours() >= 12 ? 'PM' : 'AM'}`;
  activeJob.reportReadySentAt = stamp;
  triggerAutoSave();
  openJob(activeJob);
};
document.getElementById('observationsBtn').onclick = () => {
  if (!activeJob) return;
  const pmEmail = activeJob.pmEmail || '';
  if (!pmEmail) {
    alert('No PM email available.');
    return;
  }
  const subject = `üü° ${activeJob.name || ''} ${activeJob.number || ''}`;
  let firstName = 'All';
  if (activeJob.clientProjectManager) {
    const nameParts = activeJob.clientProjectManager.trim().split(' ');
    firstName = nameParts[0] || 'All';
  }
  const body = `${firstName},

Read, See attached observations. Please select or fill out each item with a response and send back to us here. This will ensure we are only checking items that are ready to re-check.

Thank you,

`;
  window.open(`mailto:${encodeURIComponent(pmEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
  const now = new Date();
  const stamp = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')} ${now.getHours() >= 12 ? 'PM' : 'AM'}`;
  activeJob.observationsSentAt = stamp;
  triggerAutoSave();
  openJob(activeJob);
};
document.getElementById('startEmail').onclick = () => {
  if (!activeJob) return;
  const pmEmail = activeJob.pmEmail || '';
  const preConEmail = activeJob.preConEmail || '';
  const tbeEmail = activeJob.tbeEmail || '';
  const ccList = [preConEmail, tbeEmail, 'dfunchess@palmettoairbalance.com'].filter(e => e).join(',');
  let firstName = 'All';
  if (activeJob.clientProjectManager) {
    const nameParts = activeJob.clientProjectManager.trim().split(' ');
    firstName = nameParts[0] || 'All';
  }
  const subject = `üî¥ ${activeJob.name || ''} ${activeJob.number || ''}`;
  const body = `${firstName},

I am the Project Manager for test and balance on this project.
Please provide the following listed below for Test and Balance(TAB):
SEND TO ME:
üî¥(Tentative start date for TAB)
üî¥(Project completion date for TAB)
üî¥(Pre TAB Checklist) Link‚ûî https://shorturl.at/LkY45
SEND TO OUR PRECONSTRUCTION TEAM (IF NOT SENT ALREADY): dfunchess@palmettoairbalance.com
üî¥(TAB Specs and Tolerances)
üî¥(Equipment submittals)
üî¥(Final approved construction mechanical drawings to be used)
Any important job requirements or information to help ensure a successful start is greatly appreciated!
ùêçùêéùêìùêÑ:
‚Ä¢ We schedule every Thursday for the following week.
‚Ä¢ If a start date has been requested, we will contact you on our scheduling day to confirm.
‚Ä¢ If you do not respond to confirm the schedule, your project will not be scheduled.

Thank you,
`;
  if (pmEmail) {
    window.open(`mailto:${encodeURIComponent(pmEmail)}?cc=${encodeURIComponent(ccList)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
    const now = new Date();
    const stamp = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')} ${now.getHours() >= 12 ? 'PM' : 'AM'}`;
    activeJob.startEmailSentAt = stamp;
    triggerAutoSave();
    openJob(activeJob);
  } else {
    alert('No Client PM email available for this job. Please enter it in the spreadsheet view.');
  }
};
document.getElementById('deleteJobBtn').onclick = function() {
  if (!activeJob) return;
  if (!confirm(`Delete job "${activeJob.name || 'Unnamed'} ${activeJob.number || ''}" permanently?`)) return;
  
  const index = jobs.indexOf(activeJob);
  if (index > -1) {
    jobs.splice(index, 1);
    document.getElementById('detailPane').classList.remove('open');
    renderAll();
    triggerAutoSave();
  }
};
document.getElementById('prevMonth').onclick = () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderAll(); };
document.getElementById('nextMonth').onclick = () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderAll(); };
document.getElementById('backBtn').onclick = () => detailPane.classList.remove('open');
document.getElementById('editBtn').onclick = openEditPane;
document.getElementById('editBackBtn').onclick = () => editPane.classList.remove('open');
document.getElementById('saveEditBtn').onclick = saveEditPane;
document.querySelectorAll('#jobTable th').forEach(th => th.onclick = () => { sortJobs(th.dataset.field); renderList(); });
document.getElementById('jobSearch').addEventListener('input', () => {
  const query = document.getElementById('jobSearch').value.toLowerCase();
  if (!query) { renderList(); return; }
  const filtered = jobs.filter(j => (j.name||'').toLowerCase().includes(query) || (j.number||'').toLowerCase().includes(query) || (j.customer||'').toLowerCase().includes(query));
  renderList(filtered.slice(0,10));
});
function sortJobs(field) {
  const dir = sortDirection[field] === 'asc' ? 'desc' : 'asc';
  sortDirection[field] = dir;
  jobs.sort((a, b) => {
    let valA = a[field] || '';
    let valB = b[field] || '';
    if (field === 'hours') { valA = parseFloat(valA) || 0; valB = parseFloat(valB) || 0; }
    if (valA < valB) return dir === 'asc' ? -1 : 1;
    if (valA > valB) return dir === 'asc' ? 1 : -1;
    return 0;
  });
}
function renderAll() {
  renderCalendar();
  renderList();
  renderPendingReports();
  makeJobsDraggable();
  if (window.hot) updateSpreadsheetData();
}
let hot = null;
function getAllKeys() {
  if (jobs.length === 0) return [];
  return Object.keys(jobs.reduce((acc, job) => ({...acc, ...job}), {}));
}
function getFilteredJobs(searchQuery) {
  if (!searchQuery) return jobs;
  const lowerQuery = searchQuery.toLowerCase();
  return jobs.filter(job => Object.values(job).some(val => val != null && val.toString().toLowerCase().includes(lowerQuery)));
}
function getHandsontableData(searchQuery = '') {
  const filteredJobs = getFilteredJobs(searchQuery);
  if (filteredJobs.length === 0) return [[]];
  const keys = getAllKeys();
  const header = keys;
  const data = filteredJobs.map(job => keys.map(key => job[key] ?? ''));
  return [header, ...data];
}
function updateSpreadsheetData() {
  const searchQuery = document.getElementById('spreadsheetSearch').value;
  if (hot) hot.loadData(getHandsontableData(searchQuery));
}
function initSpreadsheet() {
  const container = document.getElementById('spreadsheetContainer');
  const data = getHandsontableData('');
  hot = new Handsontable(container, {
    data: data,
    rowHeaders: true,
    colHeaders: true,
    height: '100%',
    width: '100%',
    licenseKey: 'non-commercial-and-evaluation',
    stretchH: 'all',
    fixedRowsTop: 1,
    contextMenu: {
      items: {
        'delete_row': {
          name: 'Delete this job (row)',
          callback: function(key, selection) {
            if (!confirm('Are you sure you want to permanently delete this job row?')) return;

            const visualRow = selection[0].start.row;
            if (visualRow === 0) return;

            const filtered = getFilteredJobs(document.getElementById('spreadsheetSearch').value);
            const jobToDelete = filtered[visualRow - 1];
            if (!jobToDelete) return;

            const realIndex = jobs.indexOf(jobToDelete);
            if (realIndex !== -1) {
              jobs.splice(realIndex, 1);
            }

            updateSpreadsheetData();
            if (activeJob === jobToDelete) {
              document.getElementById('detailPane').classList.remove('open');
              activeJob = null;
            }
            renderAll();
            triggerAutoSave();
          }
        }
      }
    },
    cells: function(row, col) { 
      if (row === 0) return { readOnly: true, className: 'htHeader' }; 
    },
    afterChange: function(changes, source) {
      if (source === 'loadData' || !changes) return;
      changes.forEach(([row, prop, oldVal, newVal]) => {
        if (row === 0) return;
        const key = hot.getDataAtCell(0, prop);
        const filteredJobs = getFilteredJobs(document.getElementById('spreadsheetSearch').value);
        const actualJobIndex = jobs.indexOf(filteredJobs[row - 1]);
        if (actualJobIndex !== -1) jobs[actualJobIndex][key] = newVal;
      });
      renderAll();
      triggerAutoSave();
    }
  });
}
document.getElementById('viewSpreadsheet').onclick = () => {
  document.getElementById('app').style.display = 'none';
  document.getElementById('spreadsheetView').classList.add('active');
  if (!hot) initSpreadsheet();
  else updateSpreadsheetData();
};
document.getElementById('backToMain').onclick = () => {
  document.getElementById('spreadsheetView').classList.remove('active');
  document.getElementById('app').style.display = 'flex';
};
document.getElementById('addRow').onclick = () => {
  const newJob = {
    name: 'New Job',
    number: '',
    startDate: '',
    scheduledDate: '',
    status: 'TAB',
    fieldOps: 'TAB',
    location: '',
    customer: '',
    hours: '',
    clientProjectManager: '',
    pmNumber: '',
    pmEmail: '',
    preConEmail: '',
    tbeEmail: '',
    notes: '',
    reportSent: false,
    reportReadySentAt: '',
    startEmailSentAt: '',
    observationsSentAt: '',
    statusWarning: false,
    newJobFlag: false
  };
  jobs.push(newJob);
  updateSpreadsheetData();
  renderAll();
  triggerAutoSave();
};
document.getElementById('addColumn').onclick = () => {
  const colName = prompt('Enter new column name:');
  if (!colName || !colName.trim()) return;
  const cleanName = colName.trim();
  jobs.forEach(job => { if (!(cleanName in job)) job[cleanName] = ''; });
  updateSpreadsheetData();
  alert(`Column "${cleanName}" added to all jobs!`);
  triggerAutoSave();
};
document.getElementById('spreadsheetSearch').addEventListener('input', () => updateSpreadsheetData());
renderAll();
</script>
</body>
</html>
